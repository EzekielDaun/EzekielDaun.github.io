<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>A First Step in STM32 Embedded Rust - Ez&#39;s blog</title><meta name="Description" content="Ezekiel&#39;s blog"><meta property="og:title" content="A First Step in STM32 Embedded Rust" />
<meta property="og:description" content="A brief summary for recent learning about embedded rust in internship and projects.
Resources The Book: Basic rust grammar. Pay attention to Channel, Mutex, Cell, RefCell etc. in the concurrency section, which are also useful in embedded rust. Discovery: There is a new version using micro:bit when I write this blog. I was reading the STM32F3Discovery version. The Embedded Rust Book: If you are experienced in embedded systems, you can jump right in to this book." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ezekieldaun.github.io/hello-embedded-rust/" /><meta property="og:image" content="https://ezekieldaun.github.io/hello-embedded-rust/hello.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-27T18:48:13-08:00" />
<meta property="article:modified_time" content="2021-12-27T18:48:13-08:00" /><meta property="og:site_name" content="Ez&#39;s blog" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://ezekieldaun.github.io/hello-embedded-rust/hello.jpg"/>
<meta name="twitter:title" content="A First Step in STM32 Embedded Rust"/>
<meta name="twitter:description" content="A brief summary for recent learning about embedded rust in internship and projects.
Resources The Book: Basic rust grammar. Pay attention to Channel, Mutex, Cell, RefCell etc. in the concurrency section, which are also useful in embedded rust. Discovery: There is a new version using micro:bit when I write this blog. I was reading the STM32F3Discovery version. The Embedded Rust Book: If you are experienced in embedded systems, you can jump right in to this book."/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://ezekieldaun.github.io/hello-embedded-rust/" /><link rel="prev" href="https://ezekieldaun.github.io/hello-world/" /><link rel="next" href="https://ezekieldaun.github.io/balancing-bot/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "A First Step in STM32 Embedded Rust",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/ezekieldaun.github.io\/hello-embedded-rust\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/ezekieldaun.github.io\/hello-embedded-rust\/hello.jpg",
                            "width":  2771 ,
                            "height":  1279 
                        }],"genre": "posts","keywords": "Rust, Embedded","wordcount":  1433 ,
        "url": "https:\/\/ezekieldaun.github.io\/hello-embedded-rust\/","datePublished": "2021-12-27T18:48:13-08:00","dateModified": "2021-12-27T18:48:13-08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Ezekiel"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Ez&#39;s blog">EZ</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/hello-embedded-rust/" selected>English</option><option value="/zh-cn/hello-embedded-rust/">简体中文</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Ez&#39;s blog">EZ</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/hello-embedded-rust/" selected>English</option><option value="/zh-cn/hello-embedded-rust/">简体中文</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">A First Step in STM32 Embedded Rust</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://ezekieldaun.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Ezekiel</a></span>&nbsp;<span class="post-category">included in <a href="/categories/tech/"><i class="far fa-folder fa-fw"></i>tech</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-12-27">2021-12-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1433 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;7 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/hello-embedded-rust/hello.jpg"
        data-srcset="/hello-embedded-rust/hello.jpg, /hello-embedded-rust/hello.jpg 1.5x, /hello-embedded-rust/hello.jpg 2x"
        data-sizes="auto"
        alt="/hello-embedded-rust/hello.jpg"
        title="/hello-embedded-rust/hello.jpg" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#resources">Resources</a></li>
    <li><a href="#environment">Environment</a>
      <ul>
        <li><a href="#rust-toolchain">Rust Toolchain</a></li>
        <li><a href="#debugging-tools">Debugging Tools</a></li>
      </ul>
    </li>
    <li><a href="#hello-world">Hello World</a></li>
    <li><a href="#pac--hal">PAC &amp; HAL</a></li>
    <li><a href="#to-start-with-bare-metal">To Start with (Bare Metal)</a></li>
    <li><a href="#safe-global-variables">Safe Global Variables</a></li>
    <li><a href="#rtic">RTIC</a></li>
    <li><a href="#memory-allocator">Memory Allocator</a></li>
    <li><a href="#rtos">RTOS</a></li>
    <li><a href="#useful-crates">Useful Crates</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>A brief summary for recent learning about embedded rust in internship and projects.</p>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener noreffer">The Book</a>: Basic rust grammar. Pay attention to <code>Channel</code>, <code>Mutex</code>, <code>Cell</code>, <code>RefCell</code> etc. in the concurrency section, which are also useful in embedded rust.</li>
<li><a href="https://docs.rust-embedded.org/discovery/" target="_blank" rel="noopener noreffer">Discovery</a>: There is a <a href="https://docs.rust-embedded.org/discovery/microbit/" target="_blank" rel="noopener noreffer">new version</a> using micro:bit when I write this blog. I was reading the <a href="https://docs.rust-embedded.org/discovery/f3discovery/" target="_blank" rel="noopener noreffer">STM32F3Discovery</a> version.</li>
<li><a href="https://docs.rust-embedded.org/book/" target="_blank" rel="noopener noreffer">The Embedded Rust Book</a>: If you are experienced in embedded systems, you can jump right in to this book. I have the F3 board so I didn&rsquo;t use QEMU.</li>
<li><a href="https://rtic.rs" target="_blank" rel="noopener noreffer">RTIC</a>: A concurrent framework on bare metal. Better handle rust variables with ownerships. When I learned it was v0.5. Good to see that 1.0 has been released.</li>
<li><a href="https://ferrous-systems.com/blog/all/" target="_blank" rel="noopener noreffer">ferrous-systems&rsquo; blog</a>: This company introduced many technologies into embedded rust, includes testing, debugging etc. The most impressive is that they implement a <a href="https://github.com/ferrous-systems/async-on-embedded" target="_blank" rel="noopener noreffer">async/await executor</a>.</li>
</ul>
<h2 id="environment">Environment</h2>
<h3 id="rust-toolchain">Rust Toolchain</h3>
<p>Here I installed the nightly version of msvc toolchain using rustup.</p>
<p>Download core for different target platforms. Otherwise would be unable to compile:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">rustup target add thumbv6m-none-eabi        <span class="c1">#  Cortex-M0 and Cortex-M0+</span>
</span></span><span class="line"><span class="cl">rustup target add thumbv7m-none-eabi        <span class="c1">#  Cortex-M3</span>
</span></span><span class="line"><span class="cl">rustup target add thumbv7em-none-eabi       <span class="c1">#  Cortex-M4 and Cortex-M7 (no FPU)</span>
</span></span><span class="line"><span class="cl">rustup target add thumbv7em-none-eabihf     <span class="c1">#  Cortex-M4F and Cortex-M7F (with FPU)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="debugging-tools">Debugging Tools</h3>
<p>I am using the <a href="https://github.com/ScoopInstaller/Scoop" target="_blank" rel="noopener noreffer">scoop</a> package manager. So just <code>scoop install</code> the following tools:</p>
<ul>
<li>arm-none-eabi-gdb</li>
<li>openocd</li>
</ul>
<p>Besides, if using ST-LINK, manually install the driver.</p>
<p><a href="https://zhuanlan.zhihu.com/p/51872048" target="_blank" rel="noopener noreffer">This link (Chinese)</a> integrated debugging tools into vscode. Haven&rsquo;t tried since CLI is enough.</p>
<h2 id="hello-world">Hello World</h2>
<p><code>cortex-m</code> only. Other platforms untested.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cargo generate --git https://github.com/rust-embedded/cortex-m-quickstart
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>modify <code>.cargo/config.toml</code></li>
<li>modify <code>memory.x</code>. Usualy STM32 has the FLASH address on <code>0x08000000</code>, RAM address on <code>0x20000000</code>. If you see multiple RAMs in the manual, take the first one&rsquo;s size.</li>
<li>modify <code>openocd.cfg</code>, available configuring scripts could be found under openocd&rsquo;s root directory</li>
<li>run <code>openocd</code> at your project directory, keep this terminal open</li>
<li>open a new terminal window, <code>cargo run</code>, see if there&rsquo;s any output</li>
</ol>
<h2 id="pac--hal">PAC &amp; HAL</h2>
<p><strong><ruby>PAC<rt>Peripheral Access Crate</rt></ruby></strong> is usually generated automatically by <a href="https://crates.io/crates/svd2rust" target="_blank" rel="noopener noreffer">svd2rust</a>, according to the <strong><ruby>SVD<rt>CMSIS System View Description</rt></ruby></strong> file from suppliers, wraps basic operation on registers. The API is like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">pwm</span><span class="p">.</span><span class="n">ctl</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span><span class="o">|</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">globalsync0</span><span class="p">().</span><span class="n">clear_bit</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong><ruby>HAL<rt>Hardware Abstract Layer</rt></ruby></strong> is based on the PAC, (partly) implements <a href="https://crates.io/crates/embedded-hal" target="_blank" rel="noopener noreffer">embedded-hal</a>. The STM32 series have some different implementations among each other, making the code for the same peripheral usually not interchangeable. You may not use all the driver crates since it requires some traits that the HAL doesn&rsquo;t implement, or you have to use unsafe blocks to directly manipulate registers.</p>
<h2 id="to-start-with-bare-metal">To Start with (Bare Metal)</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#![no_main]</span><span class="w"> </span><span class="cm">/* use entry macro */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#![no_std]</span><span class="w"> </span><span class="cm">/* std not available */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">panic_semihosting</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"> </span><span class="cm">/* choose panic handler, need a debugger or it would block */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// use panic_halt as _;
</span></span></span><span class="line"><span class="cl"><span class="c1">// use panic_abort as _; /* need nightly toolchain */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// use cortex_m::asm; /* if need to use assembly */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">use</span><span class="w"> </span><span class="n">cortex_m_rt</span>::<span class="n">entry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// use cortex_m_semihosting::hprintln; /* println! with semihosting, makes debugging easier */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// use core::fmt::Write; /* if instead using serial port, use write! to write into serial&#39;s tx */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">hal</span>::<span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">delay</span>::<span class="n">Delay</span><span class="p">,</span><span class="w"> </span><span class="cm">/* delay function */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pac</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prelude</span>::<span class="o">*</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">stm32f1xx_hal</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">hal</span><span class="p">;</span><span class="w"> </span><span class="cm">/* import a hal */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[entry]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">cp</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/* dp: device peripherals that the MCU designer provided */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pac</span>::<span class="n">Peripherals</span>::<span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/* cp: core peripherals that comes with ARM core */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cortex_m</span>::<span class="n">Peripherals</span>::<span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/* Setup the clock tree */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">flash</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rcc</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="p">.</span><span class="n">FLASH</span><span class="p">.</span><span class="n">constrain</span><span class="p">(),</span><span class="w"> </span><span class="n">dp</span><span class="p">.</span><span class="n">RCC</span><span class="p">.</span><span class="n">constrain</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rcc</span><span class="p">.</span><span class="n">cfgr</span><span class="p">.</span><span class="n">use_hse</span><span class="p">(</span><span class="mf">8.</span><span class="n">mhz</span><span class="p">()).</span><span class="n">freeze</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">flash</span><span class="p">.</span><span class="n">acr</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/* Use SYST or other clock sources to initialize the delay object */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Delay</span>::<span class="n">new</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">SYST</span><span class="p">,</span><span class="w"> </span><span class="n">clocks</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/* gpio abstraction, depends on the hal */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">gpioa</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">gpiob</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="p">.</span><span class="n">GPIOA</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">rcc</span><span class="p">.</span><span class="n">apb2</span><span class="p">),</span><span class="w"> </span><span class="n">dp</span><span class="p">.</span><span class="n">GPIOB</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">rcc</span><span class="p">.</span><span class="n">apb2</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">loop</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/* do something */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">```</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="safe-global-variables">Safe Global Variables</h2>
<p>We all know that modifying a <code>static mut</code> variable is unsafe in rust. Tons of style guides require for less global variables as possible. However, they are commonly used in embedded systems as we are doing low level coding and the whole program is not that complex. A better way in rust is using <a href="https://rtic.rs/" target="_blank" rel="noopener noreffer">RTIC</a>. But here we start from the basics.</p>
<ul>
<li>
<p><a href="https://doc.rust-lang.org/std/sync/atomic/index.html" target="_blank" rel="noopener noreffer"><code>Atomic</code></a> is the best way if the platform supports atomic operations. Simple and safe. Disadvantages are that there cannot be complex logic, and only a few primitive types are supported.</p>
</li>
<li>
<p><code>Mutex&lt;RefCell&lt;T&gt;&gt;</code> with critical section. Need to <code>use cortex_m::interrupt::{self, Mutex};</code>. Can wrap up complex data types, including abstract for peripherals. But it makes a lot of noise in your code. The <a href="https://docs.rust-embedded.org/book/concurrency/index.html#sharing-peripherals" target="_blank" rel="noopener noreffer">usage</a>is roughly:</p>
<ol>
<li>declare a <code>static FOO:Mutex&lt;RefCell&lt;Option&lt;T&gt;&gt;&gt; = Mutex::new(RefCell::new(None));</code></li>
<li>initialize peripherals in the start of your <code>main()</code> and then open a critical section <code>interrupt::free(|cs| FOO.borrow(cs).replace(Some(T)));</code>, move the ownership to the global variable <code>FOO</code></li>
<li>to use in other places, after entering a critical section, use <code>FOO.borrow(cs).borrow()</code> to get the inner <code>RefCell</code> then <code>as_ref()</code> to get the wrapped <code>T</code></li>
</ol>
<p>I nearly never use this way as it&rsquo;s too complex and mentally exhausting. In a large project just use RTIC.</p>
</li>
</ul>
<p>This part usually makes me mad, as you have to use a bunch of layers to wrap up things that you could directly write in C, even if I know that there shouldn&rsquo;t be any problem.</p>
<h2 id="rtic">RTIC</h2>
<p>I really want to call RTIC a preemptive scheduler. If together with a memory allocator, it works just like a preemptive RTOS. However it&rsquo;s just a foreground/background system, managing tasks by setting interrupt priorities, without a context switching function. The reason we choose it is that it wraps up the complex <code>Mutex&lt;RefCell&lt;Option&lt;T&gt;&gt;&gt;</code> usage, and it can register unoccupied hardware interrupts as software interrupts with arguments and capacity.</p>
<p>However, because it uses a lot of macros, neither <strong><ruby>RLS<rt>Rust Language Server</rt></ruby></strong> nor <strong><ruby>RA<rt>Rust Analyzer</rt></ruby></strong> can perfectly auto-complete and lint. So I usually code on bare metal first, making the type right, and then copy and paste into the RTIC project.</p>
<h2 id="memory-allocator">Memory Allocator</h2>
<p><a href="https://crates.io/crates/alloc-cortex-m" target="_blank" rel="noopener noreffer">alloc-cortex-m</a>: need nightly toolchain. <a href="https://github.com/rust-embedded/alloc-cortex-m/blob/master/examples/global_alloc.rs" target="_blank" rel="noopener noreffer">usage</a></p>
<p>With a memory allocator, we can conveniently use <code>vec!</code> etc. The allocator can be config to use external memory after setting up FSMC.</p>
<h2 id="rtos">RTOS</h2>
<p>I have tried <a href="https://www.drone-os.com/" target="_blank" rel="noopener noreffer">drone</a> on both WSL and Linux PC but failed to run a hello-world&hellip; BTW it seems no longer maintained.</p>
<p>Also, there is <a href="https://book.tockos.org/" target="_blank" rel="noopener noreffer">Tock OS</a>, but you have to write peripheral drivers. The official ST <a href="https://www.tockos.org/hardware/" target="_blank" rel="noopener noreffer">demo</a> only have f3disco and two f4nucleo board, and neither have I tried.</p>
<p>I am not optimistic about RTOS in Rust, as many existing drivers are in C. Not to mention the compatibility with existing hal.</p>
<h2 id="useful-crates">Useful Crates</h2>
<ul>
<li><a href="https://crates.io/crates/heapless" target="_blank" rel="noopener noreffer">heapless</a></li>
<li><a href="https://crates.io/crates/bitbang-hal" target="_blank" rel="noopener noreffer">bitbang-hal</a></li>
<li><a href="https://crates.io/crates/nb" target="_blank" rel="noopener noreffer">nb</a>: although the name is short for non-block, it is usually used to block the code to wait for peripherals. Usage:
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">block</span><span class="o">!</span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">byte</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li><a href="https://crates.io/crates/micromath" target="_blank" rel="noopener noreffer">micromath</a>: provide operations on floating point numbers that may be missing in no_std environment</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Embedded rust is definitely acceptable for personal projects. A few disadvantages are:</p>
<ul>
<li>large binaries in debug mode. I have a <a href="https://github.com/EzekielDaun/rs-balancing-bot" target="_blank" rel="noopener noreffer">balancing-bot</a> project in which I would tell you more later.</li>
<li>annoying grammar noise</li>
</ul>
<p>I tried embedded rust for some tiny boards&rsquo; verifying demo. If the logic isn&rsquo;t too complex, you can complete the whole project in just a few minutes. I have also tried RTIC for large projects and found a few problems:</p>
<ol>
<li>basically foreground/background system, bothersome when design complex scheduling.</li>
<li>much slower that μCOSⅢ. I made a simple serial loop-back, and it could be 50% slower! Maybe I didn&rsquo;t properly config the clock&hellip; Or micrium optimized a lot in handling interrupts. I give up in 2 days, turned to μCOS, because even if I complete it, no one could maintain it lol.</li>
</ol>
<p>Rust&rsquo;s awesome trait abstraction and embedded-hal as a unified interface, make general driver crates possible. My balancing bot project was done mainly by using crates, which proved the power of these abstractions. This is also the reason STM32&rsquo;s standard peripheral library and HAL library are so popular in China. However, it inevitably brings extra code with performance trade-off, although you can depend on LLVM, but who knows. Although embedded-hal defines some traits, when out of these traits, hals are usually implemented differently, for example, the GPIO API in STM32F1XX_HAL is very different than in STM32F4XX_HAL. The last thing is only my guess. C++ also has virtual functions, where defining a unified interface is definitely possible. Why they don&rsquo;t use C++? The virtual table may have performance loss, but the compiler could choose other implementation since compilers for embedded chips are commonly hacked by these companies with some magic.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-12-27</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/rust/">Rust</a>,&nbsp;<a href="/tags/embedded/">Embedded</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/hello-world/" class="prev" rel="prev" title="Hello World"><i class="fas fa-angle-left fa-fw"></i>Hello World</a>
            <a href="/balancing-bot/" class="next" rel="next" title="Balancing Bot">Balancing Bot<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.109.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://ezekieldaun.github.io" target="_blank">Ezekiel</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
